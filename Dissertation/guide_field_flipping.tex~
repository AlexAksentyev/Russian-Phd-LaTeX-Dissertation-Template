
\newcommand{\Traj}{\mathcal T}
\DeclareDocumentCommand{\Stab}{s}{\mathcal{S}\IfBooleanT{#1}{\vert_{\W_y=0}}}
\newcommand{\Fail}{\mathcal F}
\DeclareDocumentCommand{\g}{s}{\gamma\IfBooleanT{#1}{_{eff}}}
\newcommand{\CO}{\mathrm{CO}}

\subsection{Алгоритм калибровки}
Калибровка проводится в два этапа:
\begin{enumerate}
	\item На первом этапе выставляется такое значение магнитного поля, при котором пучок не теряется. В первом приближении, это та же величина, что и была в на предыдущей инжекции, но с противоположным знаком.
	\item На втором этапе, величина поля подстраивается таким образом, чтобы соблюдалось условие замороженности спина в горизонтальной плоскости $\w_y = 0$.
\end{enumerate}

Частоты прецессии спинов частиц пучка определяются по формуле~\cite[стр.~4]{COSY:SpinTuneMapping}
\[
(\w_x, \w_y, \w_z) = 2\pi\cdot f_{rev} \cdot \nu_s \cdot \bar n,
\]
где $f_{rev}$ есть циклотронная частота частицы, а $\nu_s$ и $\bar n$ --- её спин-тюн, и ось стабильного спина, соответственно. 

Поскольку мы меняем направление магнитного поля на противоположное, $\nbar^{CW} \approx -\nbar^{CCW}$.

\subsection{Симуляция}
Пусть $\Traj$ обозначает множество всех возможных траекторий частицы в ускорителе. $\Traj = \Stab \bigcup \Fail$,
где $\Stab$ это все стабильные траектории, $\Fail$ это такие траектории, при попадании на одну из которых
частица улетает из пучка.

Первое, что мы делаем, после смены полярности поля --- это подстраиваем его величину так, чтобы частицы
инжектированного пучка попадали на траектории $t\in \Stab$. Это то же самое, что сказать, что выполняется
условие $E + vB = \frac{mv^2}{R}$, и то же самое, что и $\avg{F_L} = 0$.
($\forall t [t\in\Stab \leftrightarrow \avg{F_L} = 0]$.)

Наше второе условие, $\W_y = 0$, выбирает из $\Stab$ подмножество $\Stab*$ траекторий,
для которых спин заморожен в горизонтальной плоскости.


